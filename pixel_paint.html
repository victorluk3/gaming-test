
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
  <title>Pixel Canvas</title>
  <style>
    body {
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: #eee;
    }
    #toolbar {
      padding: 10px;
      background: #ddd;
    }
    #canvasContainer {
      flex: 1;
      overflow: auto;
    }
    canvas {
      background: white;
      image-rendering: pixelated;
      cursor: crosshair;
    }
    #palette {
      margin-top: 10px;
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }
    .swatch {
      width: 20px;
      height: 20px;
      border: 2px solid #444;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      color: black;
      text-shadow: 1px 1px white, -1px -1px white;
      cursor: pointer;
    }

      .color-swatch {
        width: 20px;
        height: 20px;
        border: 2px solid #666;
        cursor: pointer;
        border-radius: 4px;
        padding: 3px;
        color: black;
        text-align: center;
        font-weight: bold;
        text-shadow:
        -1px -1px 0 white,
        1px -1px 0 white,
        -1px  1px 0 white,
        1px  1px 0 white;
      }

    .file-button {
        display: inline-block;
        padding: 3px 6px;
        background-color: #ddd;
        border: 1px solid #aaa;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        user-select: none;
        transition: background-color 0.2s;
      }
      
      .file-button:hover {
        background-color: #ccc;
      }
      
      .file-button input[type="file"] {
        display: none;
      }
      #notificationContainer {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 1000;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.notification {
  background: #333;
  color: #fff;
  padding: 10px 14px;
  border-radius: 8px;
  font-size: 14px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  opacity: 0.95;
  transition: opacity 0.3s ease;
}
  </style>
</head>
<body>
  <div id="toolbar">
      <div class="toolbar-row">
        Lienzo: <input type="text" id="size" value="32" style="width:50px">
        <button onclick="newCanvas()" class="file-button" title="Nuevo">‚ûï</button>
          <label class="file-button">üß© Plantilla
            <input type="file" id="templateInput"  accept="application/json" hidden />
          </label>

        <button onclick="generateTemplateFromCanvas()" class="file-button">üîó Compartir lienzo</button>
      </div>


        <div class="toolbar-row">
          <button onclick="validateTemplate()">üßπ Validar</button>
          <button onclick="zoomIn()" class="file-button">üîç+</button>
          <button onclick="zoomOut()" class="file-button">üîç-</button>
          <label>
          <input type="checkbox" id="toggleLabels" checked onchange="drawCanvas()" />
          Mostrar n√∫meros
        </label>
        <label>
          <input type="checkbox" id="toggleGrid" checked onchange="drawCanvas()" />
          Mostrar cuadr√≠cula
        </label>
        </div>
        <div class="toolbar-row">
            <input type="color" id="colorPicker" value="#000000" />
            <button onclick="setTool('pencil')" class="file-button" class="file-button">üñåÔ∏è</button>
            <button onclick="setTool('bucket')" class="file-button" class="file-button">üíß </button>
            <!-- <button onclick="setTool('eraser')" class="file-button">üßΩ</button> -->
        </div>
        <div class="toolbar-row" style="margin-top: 10px;">
          <!-- paleta de colores en segunda fila -->
          <div id="palette">
            <span class="color-swatch" style="background:#000000;" data-color="#000000">1</span>
            <span class="color-swatch" style="background:#ffffff;" data-color="#ffffff">2</span>
            <span class="color-swatch" style="background:#ff0000;" data-color="#ff0000">3</span>
            <span class="color-swatch" style="background:#00ff00;" data-color="#00ff00">4</span>
            <span class="color-swatch" style="background:#0000ff;" data-color="#0000ff">5</span>
            <span class="color-swatch" style="background:#ffff00;" data-color="#ffff00">6</span>
            <span class="color-swatch" style="background:#00ffff;" data-color="#00ffff">7</span>
            <span class="color-swatch" style="background:#ff00ff;" data-color="#ff00ff">8</span>
          </div>
        </div>
  </div>
  <div id="canvasContainer">
    <canvas id="pixelCanvas" width="32" height="32"></canvas>
  </div>

  <script>

    let currentTool = "pencil"; // "pencil" o "bucket"


    function setTool(tool){
      currentTool = tool
    }

    const canvas = document.getElementById('pixelCanvas');
    const ctx = canvas.getContext('2d');
    const colorPicker = document.getElementById('colorPicker');
    const paletteContainer = document.getElementById('palette');
    const defPallete = [
        { text: 1, value: '#000000' },
        { text: 2, value: '#FFFFFF' },
        { text: 3, value: '#FF0000' },
        { text: 4, value: '#00FF00' },
        { text: 5, value: '#0000FF' },
        { text: 6, value: '#FFFF00' },
        { text: 7, value: '#00FFFF' },
        { text: 8, value: '#FF00FF' }
      ];
    let currentPalette = [];
    currentPalette = Object.assign([], defPallete)


    function updatePalette(){
      paletteContainer.innerHTML = '';
      console.log(currentPalette)
      currentPalette.forEach(p => {
        const swatch = document.createElement('div');
        swatch.className = 'color-swatch';
        swatch.style.background = p.value;
        swatch.innerText = p.text;
        swatch.title = p.value;
        swatch.onclick = () => colorPicker.value = p.value;
        paletteContainer.appendChild(swatch);
      });
    }
    updatePalette()




    let zoom = 20;
    let size = 32;
    let pixels = Array.from({ length: size }, () => Array(size).fill('#ffffff'));
    let labels = Array.from({ length: size }, () => Array(size).fill(null));

    function newCanvas(){
      size = parseInt(document.getElementById('size').value);
      zoom = 20;
      pixels = Array.from({ length: size }, () => Array(size).fill('#ffffff'));
      labels = Array.from({ length: size }, () => Array(size).fill(null));
      localStorage.clear()
      currentPalette = Object.assign([], defPallete)
      drawCanvas()
    }

    function drawCanvas() {
      //size = parseInt(document.getElementById('size').value)

      canvas.width = size * zoom;
      canvas.height = size * zoom;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.font = `${Math.max(zoom / 2.5, 8)}px sans-serif`;
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";

  const showGrid = document.getElementById("toggleGrid").checked;
  const showLabels = document.getElementById("toggleLabels").checked;

      for (let y = 0; y < size; y++) {
        for (let x = 0; x < size; x++) {
          ctx.fillStyle = pixels[y][x];
          ctx.fillRect(x * zoom, y * zoom, zoom, zoom);

          if (showGrid) {
            ctx.strokeStyle = "#ccc";
            ctx.strokeRect(x * zoom, y * zoom, zoom, zoom);
          }

          const label = labels[y][x];
          if (label !== null && showLabels) {
            ctx.fillStyle = "#000";
            ctx.fillText(label, x * zoom + zoom / 2, y * zoom + zoom / 2);
          }
        }
      }

      
    }


function validateTemplate() {
  if (!currentPalette || currentPalette.length === 0) {
    alert("No hay paleta cargada para validar.");
    return;
  }

  // Mapa de n√∫mero ‚Üí color
  const paletteMap = {};
  currentPalette.forEach(p => {
    paletteMap[p.text] = normalizeColor(p.value);
  });

  let errores = 0;

  for (let y = 0; y < size; y++) {
    for (let x = 0; x < size; x++) {
      const label = labels[y][x];
      if (label === null) continue;

      const expectedColor = paletteMap[label];
      const actualColor = normalizeColor(pixels[y][x]);

      if (expectedColor && actualColor !== expectedColor && actualColor != '#ffffff') {
        pixels[y][x] = "#ffffff"; // Resetear
        errores++;
      }
    }
  }

  drawCanvas();
  saveArtToLocal();

  if (errores === 0) {
    showNotification("‚úÖ Al momento, todo esta correctamente pintado.");
  } else {
    showNotification(`‚ùå Se corrigieron ${errores} p√≠xeles incorrectos.`);
  }
}

function showNotification(message, duration = 3000) {
  const container = document.getElementById("notificationContainer");
  const notif = document.createElement("div");
  notif.className = "notification";
  notif.textContent = message;
  container.appendChild(notif);

  setTimeout(() => {
    notif.style.opacity = 0;
    setTimeout(() => container.removeChild(notif), 300);
  }, duration);
}

    function floodFillByLabel(x, y, targetLabel, fillColor) {
  const visited = new Set();
  const queue = [[x, y]];
  const key = (x, y) => `${x},${y}`;

  while (queue.length > 0) {
    const [cx, cy] = queue.shift();
    if (cx < 0 || cy < 0 || cx >= size || cy >= size) continue;
    if (visited.has(key(cx, cy))) continue;
    if (labels[cy][cx] !== targetLabel) continue;

    pixels[cy][cx] = fillColor;
    visited.add(key(cx, cy));

    queue.push([cx + 1, cy]);
    queue.push([cx - 1, cy]);
    queue.push([cx, cy + 1]);
    queue.push([cx, cy - 1]);
  }
}

    function bucketFillByLabel(targetLabel, fillColor) {
  for (let y = 0; y < size; y++) {
    for (let x = 0; x < size; x++) {
      if (labels[y][x] === targetLabel) {
        pixels[y][x] = fillColor;
      }
    }
  }
}
function floodFill(x, y, targetColor, fillColor) {
  const queue = [[x, y]];
  const visited = new Set();

  const key = (x, y) => `${x},${y}`;

  while (queue.length > 0) {
    const [cx, cy] = queue.shift();
    if (cx < 0 || cy < 0 || cx >= size || cy >= size) continue;
    if (visited.has(key(cx, cy))) continue;
    if (pixels[cy][cx] !== targetColor) continue;

    pixels[cy][cx] = fillColor;
    visited.add(key(cx, cy));

    queue.push([cx + 1, cy]);
    queue.push([cx - 1, cy]);
    queue.push([cx, cy + 1]);
    queue.push([cx, cy - 1]);
  }
}

function normalizeColor(color) {
  const ctxTmp = document.createElement('canvas').getContext('2d');
  ctxTmp.fillStyle = color;
  return ctxTmp.fillStyle.toLowerCase(); // ej. "#ff0000"
}

function saveArtToLocal() {
  const data = {
    size,
    pixels,
    labels,
    palette: currentPalette 
  };
  localStorage.setItem("pixelArtData", JSON.stringify(data));
}
  function zoomIn() {
    zoom = Math.min(zoom + 5, 60);
    drawCanvas();
  }
  function zoomOut() {
    zoom = Math.max(zoom - 5, 5);
    drawCanvas();
  }

function generateTemplateFromCanvas() {
  const usedColors = new Map();
  const template = [];
  let colorIndex = 0;

  for (let y = 0; y < size; y++) {
    const row = [];
    for (let x = 0; x < size; x++) {
      let color = pixels[y][x] || "#ffffff";
      color = normalizeColor(color).toUpperCase();

      if (!usedColors.has(color)) {
        usedColors.set(color, colorIndex++);
      }

      row.push(usedColors.get(color));
    }
    template.push(row);
  }

  // Si solo hay un color, no tiene sentido compartir
  if (usedColors.size <= 1) {
    alert("No hay suficientes colores para compartir.");
    return;
  }

  const palette = Array.from(usedColors.entries()).map(([color, index]) => ({
    text: index,
    value: color
  }));

  const json = {
    pallete: palette,
    template: template
  };

  const compressed = LZString.compressToEncodedURIComponent(JSON.stringify(json));
  const shareUrl = `${location.origin}${location.pathname}?tpl=${compressed}`;

  // Copiar al portapapeles
  navigator.clipboard.writeText(shareUrl).then(() => {
    alert("‚úÖ Enlace copiado al portapapeles.");
  }).catch(() => {
    prompt("Copia este enlace:", shareUrl);
  });
}
    canvas.addEventListener('click', (e) => {
      const rect = canvas.getBoundingClientRect();
      const x = Math.floor((e.clientX - rect.left) / zoom);
      const y = Math.floor((e.clientY - rect.top) / zoom);

      if (x < 0 || x >= size || y < 0 || y >= size) return;

      if (currentTool === "pencil") {
        pixels[y][x] = colorPicker.value;
      } else if (currentTool === "bucket") {
        const targetLabel = labels[y][x];
        if (targetLabel !== null) {
          floodFillByLabel(x, y, targetLabel, normalizeColor(colorPicker.value));
        }
      }

      drawCanvas();
      saveArtToLocal()
    });

    document.getElementById('templateInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (ev) => {
        const data = JSON.parse(ev.target.result);
        if (!data.pallete || !data.template) {
          alert("Plantilla inv√°lida");
          return;
        }

        size = data.template.length;
        pixels = Array.from({ length: size }, () => Array(size).fill('#ffffff'));
        labels = Array.from({ length: size }, () => Array(size).fill(null));

        const colorMap = {};
        for (let c of data.pallete) {
          colorMap[c.text] = c.value;
        }

        // construir la paleta visual
        paletteContainer.innerHTML = '';
        currentPalette = data.pallete;
        data.pallete.forEach(p => {
          const swatch = document.createElement('div');
          swatch.className = 'color-swatch';
          swatch.style.background = p.value;
          swatch.innerText = p.text;
          swatch.title = p.value;
          swatch.onclick = () => colorPicker.value = p.value;
          paletteContainer.appendChild(swatch);
        });

        for (let y = 0; y < size; y++) {
          for (let x = 0; x < size; x++) {
            const num = data.template[y][x];
            labels[y][x] = num;
          }
        }
        drawCanvas();
        saveArtToLocal();
      };
      reader.readAsText(file);
    });

function loadFromUrl(){
  const params = new URLSearchParams(window.location.search);
const compressedTpl = params.get("tpl");
if (compressedTpl) {
  try {
    console.log('loading from url')
    const jsonStr = LZString.decompressFromEncodedURIComponent(compressedTpl);
    const data = JSON.parse(jsonStr);
    if (!data.pallete || !data.template) return;

    size = data.template.length;
    pixels = Array.from({ length: size }, () => Array(size).fill('#ffffff'));
    labels = Array.from({ length: size }, () => Array(size).fill(null));
    currentPalette = data.pallete;

    // reconstruir la paleta visual
    paletteContainer.innerHTML = '';
    currentPalette.forEach(p => {
      const swatch = document.createElement('div');
      swatch.className = 'swatch';
      swatch.style.background = p.value;
      swatch.innerText = p.text;
      swatch.title = p.value;
      swatch.onclick = () => colorPicker.value = p.value;
      paletteContainer.appendChild(swatch);
    });

    // aplicar etiquetas
    for (let y = 0; y < size; y++) {
      for (let x = 0; x < size; x++) {
        labels[y][x] = data.template[y][x];
      }
    }

    drawCanvas();
    localStorage.setItem("pixelArtData", JSON.stringify({ size, pixels, labels, palette: currentPalette }));
    history.replaceState(null, "", location.pathname); // limpiar ?tpl de la URL
  } catch (err) {
    alert("‚ùå No se pudo cargar la plantilla desde la URL.");
  }
}
}

document.addEventListener("DOMContentLoaded", () => {
   console.log('on load...')
  const saved = localStorage.getItem("pixelArtData");
    try {
     
      const params = new URLSearchParams(window.location.search);
      const compressedTpl = params.get("tpl");
      if(compressedTpl) {
        loadFromUrl()
        return
      }

      if(!saved) {
        drawCanvas()
        return
      }

      const data = JSON.parse(saved);


      if (data.size && data.pixels) {
        size = data.size;
        pixels = data.pixels;
        labels = data.labels || Array.from({ length: size }, () => Array(size).fill(null));
        currentPalette = data.palette;
        updatePalette()
        drawCanvas();
      }
    } catch (err) {
      console.error("Error cargando datos guardados:", err);
    }
  
});



  </script>
  <div id="notificationContainer"></div>
</body>
</html>
